---
name: gateway_request_async_form
resource: modules/payments/gateway_request
resource_owner: anyone
authorization_policies:
  - modules/payments/validate_signature_async
fields:
  success_message:
    property_options:
      virtual: true
  signature_properties:
    property_options:
      virtual: true
  properties:
    request_type:
    gateway:
    config:
    data:
    response:
    request_errors:

redirect_to: >
  {%- if form.properties.request_errors != blank -%}
    {{ form.properties.config.error_path | default: context.params.current_path }}
  {%- else -%}
    {{ form.properties.config.success_path | default:  context.params.redirect_to | default:  context.params.current_path }}
  {%- endif -%}
flash_notice: "{% if form.properties.request_errors != blank %}{{ form.properties.config.error_message | default: form.properties.request_errors }}{% else %}{{ form.properties.config.success_message | default: form.success_message }}{% endif %}"
callback_actions: >
async_callback_actions:
  delay: 0
  priority: high
  content: >
    {%- assign config = params.properties_attributes.config -%}
    {%- assign data = params.properties_attributes.data -%}
    {%- include "modules/payments/forms/gateway_request_default_payload",  params: params, data: data, config: config -%}
default_payload: >
  {% log "ASYNC GATEWAY REQUEST FORM SUBMITTED" %}
  {
    {% if form %}
      {% log params.properties_attributes.default_data , type: "HELLO DF" %}
      "properties_attributes": {
        "data" : {{ params.properties_attributes.default_data | json }}
      }
    {% endif %}
  }

---
{%- include 'modules/stripe/shared/api_credentials' -%}
{%- assign gateway = config.gateway | default: context.exports.payments.gateway_name -%}
{%- assign request_type = config.request_type | default: request_type -%}
{%- assign gateway_template = config.gateway_template -%}
{%- assign data_attribute = form_builder.fields.properties.data.name -%}

{% if gateway_template == blank %}
  {%- assign gateway_template = "modules/" | append: gateway | append: '/templates/' | append: request_type -%}
{% endif %}

{%- capture "signature" -%}
{% include 'modules/payments/shared/calculate_signature',
  data: data,
  config: config
%}
{%- endcapture -%}

{% form html-class: @request_type %}
  <input type="hidden" name="current_path" value="{{ context.location.href }}" />
  <input type="hidden" name="signature" value="{{ signature }}" />
  <input type="hidden" name="{{ form_builder.fields.properties.gateway.name }}" value="{{ gateway }}" />
  <input type="hidden" name="{{ form_builder.fields.properties.request_type.name }}" value="{{ request_type }}" />

  {%- for var in data -%}
    {%- parse_json "query" -%}{}{%- endparse_json -%}
    {%- assign query = query | add_hash_key: var[0], var[1] %}

    {%- parse_json "properties" -%}{}{%- endparse_json -%}
    {%- assign properties = properties | add_hash_key: "[default_data]", query %}
    {%- assign properties = properties | querify | url_decode | split: "&" -%}

    {% for q in properties %}
      {% assign property = q | split: "=" %}
      <input
        type="hidden"
        name="{{ form_builder.fields.properties.data.name | remove: "[data]" }}{{ property[0] }}"
        value="{{ property[1] }}"
        data-{{ property[0] }}="{{ property[1] }}"
      />
    {%- endfor -%}
  {%- endfor -%}


  {%- for property in config -%}
    <input
      type="hidden"
      name="{{ form_builder.fields.properties.config.name  }}[{{ property.first }}]"
      value="{{ property.last }}"
    />
  {%- endfor -%}

  {%- include gateway_template, config: config -%}
{% endform %}
