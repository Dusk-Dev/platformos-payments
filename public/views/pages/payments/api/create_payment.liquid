---
slug: payments/api/create_payment
method: post
layout_name: ''
authorization_policies:
- modules/payments/validate_api_signature
---

{%- assign gateway_name = 'stripe' -%}
{%- export gateway_name, namespace: "payments"  -%}

{%- graphql  cc = 'modules/payments/get_credit_card_by_id', id: context.params.credit_card_id -%}

{%- assign credit_card = cc.customizations.results.first -%}
{%- query_graph 'modules/payments/get_customer', result_name: "cu", id: credit_card.properties.customer_id -%}
{%- assign customer = cu.customizations.results.first -%}
{% comment %} application_fee => application_fee_amount ; New Stripe requirements {% endcomment %}
{%- assign application_fee_amount = context.params.application_fee_cents -%}
{%- assign description = context.params.description -%}
{%- assign destination = context.params.destination -%}


{% comment %} For US clients set `transfer_data[destination]` for others set `destination` {% endcomment %}
{%- if destination != blank -%}
  {%- parse_json "destination_data" -%}
  {
    "gateway_id": "{{ destination }}"
  }
  {%- endparse_json -%}

  {%- query_graph "modules/payments/gateway_get", data: destination_data, template: "modules/stripe/get_account" -%}
  {%- parse_json 'response' %}{{ g.api_call_send.response.body }}{% endparse_json -%}
  {%- if response.country == 'US' -%}
    {%- assign destination_field = '"transfer_data[destination]": "' | append: destination | append: '",' -%}
  {%- else -%}
    {%- assign destination_field = '"destination": "' | append: destination | append: '",' -%}
  {%- endif -%}
{%- endif -%}

{%- assign idempotence_key = context.params.idempotence_key -%}
{%- parse_json "payment_data" -%}
  {
    "id": "{{ credit_card.id }}",
    {%- if application_fee_amount != blank -%}"application_fee_amount": {{ application_fee_amount }},{%- endif -%}
    {%- if description != blank -%}"description": "{{ description }}",{%- endif -%}
    {%- if destination_field != blank -%}{{ destination_field }}{%- endif -%}
    {%- if idempotence_key != blank -%}"idempotence_key": "{{ idempotence_key }}",{%- endif -%}
    "customer": "{{ customer.gateway_id }}",
    "source": "{{ credit_card.properties.gateway_id }}",
    "amount": {{ context.params.amount_cents }},
    "currency": "USD"
  }
{%- endparse_json -%}
{%- parse_json "data" -%}
  {
    "properties": [
       { "name": "request_type", "value": "create_payment" },
       { "name": "data", "value":  "{{ payment_data | json | escape_javascript }}" }
     ]
  }
{%- endparse_json -%}

{%- graphql g = "modules/payments/create_customization", form: "modules/payments/gateway_request_mutation_form", data: data -%}
{%- parse_json "payment_properties" -%}
  {{ g.customization_create.properties.data }}
{%- endparse_json -%}
{%- if g.customization_create.properties.request_errors != blank -%}
  {"error": "{{ g.customization_create.properties.request_errors }}", "status":"error"}
{%- else -%}
  {%- assign response_body = g.customization_create.properties.data | to_hash -%}
  {%- if response_body.destination != blank -%}
    {%- assign destination_key = response_body.destination -%}
  {%- else -%}
    {%- assign destination_key = response_body['transfer_data[destination]'] -%}
  {% endif %}
  {{ payment_properties | add_hash_key: 'id', g.customization_create.id | add_hash_key: 'status', 'ok' | add_hash_key: 'application_fee', response_body.application_fee_amount | add_hash_key: 'destination', destination_key | json }}
  {%- log payment_properties -%}
{%- endif -%}
