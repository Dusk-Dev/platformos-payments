---
slug: webhooks/listen
method: post
layout_name: ''
authorization_policies:
---
{%- include 'modules/stripe/shared/api_credentials' -%}

{% log context, type: "webhook context" %}
{% log params %}

{%- assign stripe_signature = context.headers.HTTP_STRIPE_SIGNATURE | split: "," %}
{%- assign t = stripe_signature[0] | split: '=' | last %}
{%- assign secret = stripe_signature[1] | split: '=' | last %}
{%- assign webhook_name = params.type | replace: ".", "_" -%}

{% log webhook_name, type: 'webhook name' %}

{% if webhook_name contains "subscription" or webhook_name contains "checkout" %}
  {% assign is_connect = false %}
{% else %}
  {% assign is_connect = true %}
{% endif %}

{% if context.constants.payment_livemode != blank %}
  {% assign livemode = true %}
{% else %}
  {% assign livemode = false %}
{% endif %}

{%- assign webhook_listen_url = "https://" | append: context.location.host | append: "/webhooks/listen" %}

{% log webhook_listen_url, type: 'webhook listen url' %}
{% log livemode, type: 'livemode' %}
{% log is_connect, type: 'connect' %}

{% graphql webhook_config = 'modules/payments/get_webhook_endpoint',
  livemode: livemode, url: webhook_listen_url, is_connect: is_connect
  | dig: 'models', 'results'
  | first
%}

{% log webhook_config, type: 'webhook endpoint' %}

{% if webhook_config.id == blank %}
  {% log "webhook_endpoint NOT FOUND", type: "ERROR" %}
{% endif %}

{%- capture "signed_payload" -%}{{ t }}.{{ context.post_params }}{% endcapture %}

{%- assign webhook_secret = webhook_config.properties.secret %}
{%- assign signed_payload_hmac = signed_payload | compute_hmac: webhook_secret %}

{% if secret == signed_payload_hmac %}
  {% parse_json 'webhook_data' %}{{ context.post_params }}{% endparse_json %}
  
  {%- assign webhook_processor = "modules/stripe/webhook_processors/" | append: webhook_name -%}
  {%- include webhook_processor, data: webhook_data.data.object, webhook_data: webhook_data -%}
{% else %}
  {% response_status 403 %}
  {% log 'DEBUG secret not match', type: 'payments_webhook_listen' %}
{% endif %}
