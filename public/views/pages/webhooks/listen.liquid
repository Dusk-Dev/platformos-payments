---
slug: payments/webhooks/listen
method: post
layout_name: ''
authorization_policies:
  - modules/payments/validate_stripe_signature
---
{% graphql request = 'modules/payments/get_request_headers' %}
{% assign header = request.request.headers['HTTP_STRIPE_SIGNATURE'] | split: ',' %}
{% capture signature_json %}
{
  {% for element in header  %}
    {% assign kv = element | split: '=' %}
    "{{ kv[0] }}": "{{ kv[1] }}"{% if forloop.last != true %},{% endif %}
  {% endfor %}
}
{% endcapture %}
{% assign signature_hash = signature_json | to_hash %}
{% assign params_json = request.request.body %}
{% assign signed_payload = signature_hash.t | append: '.' | append: params_json %}
{% assign signature = signed_payload | compute_hmac: context.constants.stripe_webhook_secret  %}


{% if signature == signature_hash.v1 %}
  {% if params.type == 'account.updated' %}
    {% include 'modules/payments/webhooks/account_updated' params: params %}
  {% endif %}
{% endif %}