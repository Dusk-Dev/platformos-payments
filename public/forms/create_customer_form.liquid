---
name: create_customer_form
resource: modules/payments/customer
request_allowed: false
resource_owner: anyone
fields:
  properties:
    email:
    default_source:
    description:
      property_options:
        virtual: true
    gateway_id:
      validation:
        presence: true
    external_id:
    source:
      property_options:
        virtual: true
    skip_credit_card_creation:
      property_options:
        virtual: true
    card_brand:
    card_exp_month:
    card_exp_year:
    card_last4:
    source_type:
      property_options:
        virtual: true
    account_holder_name:
      property_options:
        virtual: true
    account_holder_type:
      property_options:
        virtual: true
    bank_name:
      property_options:
        virtual: true
    last4:
      property_options:
        virtual: true
    routing_number:
      property_options:
        virtual: true
callback_actions: >
  {% log form, type:"form" %}
  {% if form.properties.default_source != blank %}
    {% if form.properties.skip_credit_card_creation != "true" and form.properties.source_type == "card" %}
      {% comment %}  TODO move to Stripe module  {% endcomment %}
      {% parse_json 'data' %}
        {
          "properties": [
            { "name": "customer_id", "value": "{{ form.id }}" },
            { "name": "external_id", "value": "{{ form.properties.external_id }}" },
            { "name": "gateway_id", "value": "{{  form.properties.default_source }}" },
            { "name": "gateway_customer_id", "value": "{{  form.properties.gateway_id }}" },
            { "name": "brand", "value": "{{ form.properties.card_brand }}" },
            { "name": "exp_month", "value": "{{ form.properties.card_exp_month }}" },
            { "name": "exp_year", "value": "{{ form.properties.card_exp_year }}" },
            { "name": "last4", "value": "{{ form.properties.card_last4 }}"}
          ]
        }
      {% endparse_json %}

      {%- graphql g_card = 'modules/payments/create_customization',
        data: data, form: 'modules/payments/create_credit_card_form'
      -%}

      {% log g_card, type: "credit_card" %}
    {% endif %}
    {% if form.properties.source_type == "bank_account" %}
      {% comment %}  TODO move to Stripe module  {% endcomment %}
      {% parse_json 'data' %}
        {
          "properties": [
            { "name": "customer_id", "value": "{{ form.id }}" },
            { "name": "external_id", "value": "{{ form.properties.external_id }}" },
            { "name": "gateway_id", "value": "{{  form.properties.default_source }}" },
            { "name": "gateway_customer_id", "value": "{{  form.properties.gateway_id }}" },
            { "name": "account_holder_name", "value": "{{ form.properties.account_holder_name }}" },
            { "name": "account_holder_type", "value": "{{ form.properties.account_holder_type }}" },
            { "name": "bank_name", "value": "{{ form.properties.bank_name }}" },
            { "name": "last4", "value": "{{ form.properties.last4 }}" },
            { "name": "routing_number", "value": "{{ form.properties.routing_number }}" }
          ]
        }
      {% endparse_json %}

      {%- graphql g_bank_account = 'modules/payments/create_customization',
        data: data, form: 'modules/payments/create_bank_account_form'
      -%}

      {% log bank_account, type: "bank_account" %}
    {% endif %}
  {% endif %}
default_payload: >
---
